<template>
    <div>
      <b-container fluid>
        <b-card>
                <b-row>
                    <b-col cols="8">
                        <p class="vul-name">{{ actualVulName }}</p>
                    </b-col>
                    <b-col cols="3">
                    </b-col>
                    <b-col cols="1">
                        <span size="sm" class="high" v-if="sev===3">High</span>
                        <span size="sm" class="medium" v-if="sev===2">Medium</span>
                        <span size="sm" class="low" v-if="sev===1">Low</span>
                        <span size="sm" class="info" v-if="sev===0">Info</span>
                    </b-col>
                </b-row>
                <b-tabs pills card >
                    <b-tab title="Basic Info" active v-if="basicInfo.length>0">
                        <basic-info :basicInfoData="basicInfo"></basic-info>
                    </b-tab>
                    <b-tab title="Vulnerability Info" v-if="vulInfo.length>0 && vulInfo.desc">
                        <vulnerability-info :vulInfo="vulInfo"></vulnerability-info>
                    </b-tab>
                    <b-tab title="Affected Instances" v-if="affectedInstances.length>0">
                        <affected-instances :affectedInstances="affectedInstances" @anotherPage="clickedInstance($event)"></affected-instances>
                    </b-tab>
                  <b-tab title="Remediation Info">
                    <remediation-info :remedyInfoData="remedyInfoData" :logoInfo="logo"></remediation-info>
                  </b-tab>
                </b-tabs>
            </b-card>
      </b-container>
    </div>
</template>

<script>
    import BasicInfo from '@/components/IndividualVulnerability/BasicInfo'
    import VulnerabilityInfo from '@/components/IndividualVulnerability/VulnerabilityInfo'
    import AffectedInstances from '@/components/IndividualVulnerability/AffectedInstances'
    import RemediationInfo from '@/components/IndividualVulnerability/RemediationInfo'
    import axios from '@/utils/auth'
    import { notValidUser } from '@/utils/checkAuthUser'

    export default {
      name: 'ClosedIndividualVul',
      components: {
        BasicInfo,
        VulnerabilityInfo,
        AffectedInstances,
        RemediationInfo
      },
      data() {
        return {
          basicInfo: [],
          vulInfo: [],
          affectedInstances: [],
          remedyInfoData: [],
          actualVulName: '',
          logo: ''
        }
      },
      created() {
        this.org = localStorage.getItem('org')
        this.token = localStorage.getItem('token')
        this.appName = this.$route.params.appName
        this.vulName = this.$route.params.vulName
        this.cwe = this.$route.params.cwe
        this.fetchData()
      },
      methods: {
        fetchData() {
          if (this.org && this.token) {
            axios.get('/closedvul/' + this.appName + '/' + this.vulName + '/' + this.cwe+'/')
              .then(res => {
                for (const val of Object.values(res.data)) {
                  var remedyFile = ''
                  if (val.remediation.file) {
                    axios.get(val.remediation.file)
                      .then(res => {
                        remedyFile = res.data
                        this.logo = res.data
                      }).catch(error => {
                        if (error.res.status === 404) {
                          this.$router.push('/not_found')
                        } else if (error.res.status === 403) {
                          this.$router.push('/forbidden')
                        } else {
                          this.$router.push('/error')
                        }
                      })
                  }
                  this.remedyInfoData.push({
                    'remediatedOn': val.remediation.remediated_on,
                    'remediatedBy': val.remediation.remediated_by,
                    'remediatedFile': remedyFile,
                    'remediatedDesc': val.remediation.description
                  })
                  this.vulInfo.push({
                    desc: val.description
                  })
                  this.actualVulName = val.names[0][0]
                  this.sev = val.sev
                  this.basicInfo.push({
                    'appName': val.names[0][1],
                    'appUrl': val.app_url,
                    'tool': val.tools,
                    'owasp': val.owasp,
                    'cwe': val.cwe,
                    'impact': val.impact,
                    'openFor': null,
                    'timeOfIntroducation': val.time_intro,
                    'languages': val.languages,
                    'bugStatus': val.bug_status,
                    'bugId': val.bug_id,
                    'dread': val.dread,
                    'dreadValues': 'Damage: ' + val.damage + '\n' + 'Reproducibility: ' + val.reproducibility +
                      '\n' + 'Exploitability: ' + val.exploitability + '\n' + 'Affected Users: ' + val.affected_users +
                      '\n' + 'Discoverability: ' + val.discoverability
                  })
                  for (const [key, param] of Object.entries(val.evidences)) {
                    this.affectedInstances.push({
                      evidence: key,
                      details: param
                    })
                  }
                }
              }).catch(error => {
                if (error.response.data.detail === 'Signature has expired.'){
                  notValidUser()
                  this.$router.push('/')
                }
                if (error.res.status === 404) {
                  this.$router.push('/not_found')
                } else if (error.res.status === 403) {
                  this.$router.push('/forbidden')
                } else {
                  this.$router.push('/error')
                }
              })
          } else {
            notValidUser()
            this.$router.push('/')
          }
        }
      }
    }
</script>

<style scoped>
  .vul-name {
    font-family: 'Avenir';
    font-size: 14px;
    font-weight: 600;
    line-height: 0.99;
    text-align: left;
    color: #232328;
}
  .high {
    display: inline-block;
    min-width: 35px;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.75;
    color: #FFFFFF;
    text-align: center;
    font-family: 'Avenir';
    white-space: nowrap;
    vertical-align: middle;
    background-color: #d11d55;
    height: 25px;
    margin-right: 3%;
}
.medium {
    display: inline-block;
    min-width: 35px;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.75;
    color: #FFFFFF;
    text-align: center;
    font-family: 'Avenir';
    white-space: nowrap;
    vertical-align: middle;
    background-color: #ff9c2c;
    height: 25px;
    margin-right: 3%;
}
.low {
    display: inline-block;
    min-width: 35px;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.75;
    color: #FFFFFF;
    text-align: center;
    font-family: 'Avenir';
    white-space: nowrap;
    vertical-align: middle;
    background-color: #008b8f;
    height: 25px;
    margin-right: 3%;
}
.info {
    display: inline-block;
    min-width: 35px;
    padding: 3px 7px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.75;
    color: #FFFFFF;
    text-align: center;
    font-family: 'Avenir';
    white-space: nowrap;
    vertical-align: middle;
    background-color: #1d1e52;
    height: 25px;
    margin-right: 3%;
}
</style>
