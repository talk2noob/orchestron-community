<template>
    <div>
      <b-container fluid>
         <loading :active.sync="reloadPage" :can-cancel="true" :is-full-page="true"></loading>
        <ReqRespHeader :reqResHeaderData="reqResHeaderData"></ReqRespHeader>
        <br>
        <!-- <request-and-response :reqRespData="reqRespData" :request="request" :response="response" :log="log"></request-and-response>
         -->
         <template v-if="req_res_log.req_status || req_res_log.res_status || req_res_log.log_status">
           
            <request-and-response :reqRespData="reqRespData" 
          :request="request" :response="response" :log="log"
          :req_res_log="req_res_log"
          ></request-and-response>
         </template>

      </b-container>
    </div>
</template>

<script>
    import ReqRespHeader from '@/components/RequestAndResponse/Header'
    import RequestAndResponse from '@/components/RequestAndResponse/RequestAndResponse'
    import axios from '@/utils/auth'
    import { notValidUser } from '@/utils/checkAuthUser'
    import Loading from 'vue-loading-overlay'

    export default {
      name: 'IndividualReqResp',
      components: {
        ReqRespHeader,
        RequestAndResponse,
        Loading
      },
      data() {
        return {
          reqRespData: [],
          request: false,
          reloadPage: false,
          response: false,
          log: false,
          reqResHeaderData: [],
          requested_url:'',
          response_url:'',
          log_url:'',
          req_res_log: {req: [],req_status:false,res:[],res_status:false,log:[],log_status:false}
        }
      },
      created() {
        this.org = localStorage.getItem('org')
        this.token = localStorage.getItem('token')
        this.appName = this.$route.params.appName
        this.vulName = this.$route.params.vulName
        this.cwe = this.$route.params.cwe
        this.url = this.$route.params.url
        this.param = this.$route.params.param
        this.fetchAsyncData()
      },
      methods: {
           async  fetchData() {
          if (this.org && this.token) {
            this.reloadPage = true
          await  axios.get('/openvul/' + this.appName + '/' + this.vulName + '/' + this.cwe + '/' + this.url + '/')
              .then(res => {
           for (const val of Object.values(res.data)) {
                    this.reqResHeaderData.push({
                      appName: val.app_name,
                      appUrl: val.app_url,
                      cwe: val.cwe,
                      owasp: val.owasp,
                      tool: val.tool,
                      scanName: val.scan_short_name,
                      sanId: val.scan_id,
                      url: this.url,
                      param: this.param
                    })
                    this.requested_url= val.request
                    this.response_url =  val.response
                    this.log_url = val.log
                  }
              }).catch(error => {
                if (error.response.data.detail === 'Signature has expired.'){
                  notValidUser()
                  this.$router.push('/')
                }
                this.reloadPage = false
                if (error.res.status === 404) {
                  this.$router.push('/not_found')
                } else if (error.res.status === 403) {
                  this.$router.push('/forbidden')
                } else {
                  this.$router.push('/error')
                }
              })
          }
        },

     async fetchAsyncData(){
      this.reloadPage = true
       await this.fetchData()
        var  req = await  this.requested_url
        var  res = await  this.response_url
        var  log = await  this.log_url
       if (res) {
        await  axios.get(res)
                        .then(res => {
                          this.req_res_log['res'] = res.data
                          this.req_res_log['res_status'] = true
                        }).catch(error => {
                          if (error.response.data.detail === 'Signature has expired.'){
                            notValidUser()
                            this.$router.push('/')
                          }
                            this.reloadPage = false

                          if (error.response.status === 404) {
                            this.$router.push('/not_found')
                          } else if (error.response.status === 403) {
                            this.$router.push('/forbidden')
                          } else {
                            this.$router.push('/error')
                          }
                        })
       }
      if (req) {
            await  axios.get(req)
              .then(res => {
              this.req_res_log['req'] = res.data
              this.req_res_log['req_status'] = true
              }).catch(error => {
                if (error.response.data.detail === 'Signature has expired.'){
                            notValidUser()
                            this.$router.push('/')
                          }
                        this.reloadPage = false

              if (error.response.status === 404) {
                this.$router.push('/not_found')
              } else if (error.response.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })

          }
           if (log) {
                   await   axios.get(log)
                        .then(res => {
                          this.req_res_log['log'] = res.data
                          this.req_res_log['log_status'] = true
                        }).catch(error => {
                          if (error.response.data.detail === 'Signature has expired.'){
                            notValidUser()
                            this.$router.push('/')
                          }
                        this.reloadPage = false

                          if (error.response.status === 404) {
                            this.$router.push('/not_found')
                          } else if (error.response.status === 403) {
                            this.$router.push('/forbidden')
                          } else {
                            this.$router.push('/error')
                          }
                        })
                    }
                            this.reloadPage = false
                    
     }
   
      }
    }
</script>

<style scoped>

</style>